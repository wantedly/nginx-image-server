include authorized_ip;
include cache_path;

server {
  listen       80;
  access_log  /var/log/nginx/access.log;
  error_log   /var/log/nginx/error.log;

  root /var/www/nginx-default;

  server_name $server_name_from_env;

  location /status {
    proxy_pass http://localhost/index.html;
  }

  location /favicon.ico {
    access_log off;
  }

  location @empty {
    empty_gif;
  }

  location ~ small_light[^/]*/(.+)$ {
    proxy_pass        http://localhost:8080;
    proxy_cache       cache-space;
    proxy_cache_valid 200 60m;
  }

  location /assets {
    proxy_pass        http://localhost:8080;
    proxy_cache_valid 200 60m;
  }

  location /news_assets {
    proxy_pass        http://localhost:8080;
    proxy_cache_valid 200 60m;
  }

  location /tmp {
    proxy_pass        http://localhost:8080;
    proxy_cache_valid 200 60m;
  }
}

server {
  listen      8080;

  server_name $server_name_from_env;
  access_log  /var/log/nginx/access.log;
  error_log   /var/log/nginx/error.log;

  resolver 8.8.8.8;

  small_light on;

  location /favicon.ico {
    root       /var/www/nginx-default;
    access_log off;
  }

  location @empty {
    empty_gif;
  }

  location ~ ^/(assets|tmp|news_assets)/(.*) {
    proxy_pass http://$s3_host_from_env/$1/$2;
    error_page 415 = @empty;
  }

  location ~ small_light[^/]*/(.+)$ {
    set     $file $1;
    rewrite ^ /$file;
  }
}
